name: Deploy to S3

on:
  workflow_run:
    workflows: ["Version Bump on Release"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch: # Allow manual deployment if needed

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: prod
    # Only deploy if version-bump workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # Checkout the latest main branch to get the version bump commit
        # For manual dispatch, use current ref
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.ref || 'main' }}
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.x"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm test:coverage

      - name: Build app
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Get version for headers
        id: version
        run: |
          # Try to get version from the latest tag first (most reliable)
          # If no tag exists or we're on a different branch, fall back to package.json
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LATEST_TAG" ] && [[ "$LATEST_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # Extract version from tag (remove 'v' prefix)
            VERSION="${LATEST_TAG#v}"
            echo "Using version from latest tag: $VERSION"
          else
            # Fall back to package.json
            VERSION=$(node -p "require('./package.json').version")
            echo "Using version from package.json: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to S3 with cache headers and version metadata
        uses: ./.github/actions/deploy-to-s3
        with:
          s3-bucket: ${{ secrets.AWS_S3_BUCKET_NAME }}
          version: ${{ steps.version.outputs.version }}

      - name: Update CloudFront version header
        continue-on-error: true
        uses: ./.github/actions/update-cloudfront-version-header
        with:
          version: ${{ steps.version.outputs.version }}
          distribution-id: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          policy-name: jonykru-version-header

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
